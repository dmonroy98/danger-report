# app.py
from flask import Flask, render_template, request
import pandas as pd
from datetime import datetime
import traceback

app = Flask(__name__)

# ───────────────────────────────────────────────
#   Hardcoded instructors for now
#   ← later read from excel tabs / database
# ───────────────────────────────────────────────
INSTRUCTORS = [
    "Bianca H.",
    "Alex K.",
    "Maria L.",
    "Jordan P.",
    "Taylor R.",
    "Casey S.",
    "Felipe G.",
    # ←← add all your real instructor names here
]

def generate_table_html(instructor_name):
    """
    This is the function you will replace with your REAL excel reading logic
    Right now it returns dummy data so you can see the table appear
    """
    try:
        # ────── DUMMY DATA ──────
        # (just so you see something working)
        data = {
            "Date": ["2025-01-07", "2025-01-08", "2025-01-10", "2025-01-14"],
            "Day": ["Tuesday", "Wednesday", "Friday", "Tuesday"],
            "Class Name": ["Advanced Tactics 101", "Defensive Driving", "Emergency Response", "High Risk Ops"],
            "Location": ["Range A", "Track 3", "Sim Center", "Field B"],
            "Students Enrolled": [12, 8, 15, 9],
            "Incidents Reported": [2, 0, 3, 1],
            "Danger Level": ["Medium", "Low", "High", "Medium"],
            "Max Students": [15, 10, 20, 12]   # ← used in your special sort
        }

        df = pd.DataFrame(data)

        # You can add instructor name if you want
        # df["Instructor"] = instructor_name

        table_html = df.to_html(
            index=False,
            classes="table",
            border=0,
            escape=False,
            justify="left"
        )

        return table_html

    except Exception as e:
        print(f"Error generating table for {instructor_name}: {str(e)}")
        traceback.print_exc()
        return f'<p style="color: red; font-weight: bold; padding: 20px;">Error loading data: {str(e)}</p>'


@app.route('/danger-report')
def danger_report():
    instructor = request.args.get('instructor', '').strip()

    print(f"[LOG] Requested instructor: '{instructor}'")
    print(f"[LOG] All instructors: {INSTRUCTORS}")

    # Fallback to first instructor if invalid / empty
    if not instructor or instructor not in INSTRUCTORS:
        instructor = INSTRUCTORS[0] if INSTRUCTORS else "No Instructors Available"
        print(f"[LOG] Falling back to: '{instructor}'")

    table_html = generate_table_html(instructor)

    updated_at = datetime.now().isoformat()

    return render_template(
        'danger_report.html',
        instructor=instructor,
        instructors=INSTRUCTORS,
        table_html=table_html,
        updated_at=updated_at
    )


# Optional — nice landing page when someone opens the root url
@app.route('/')
def index():
    return """
    <h1>Danger Report App</h1>
    <p>Go to: <a href="/danger-report">/danger-report</a></p>
    <p>Or try specific instructor:</p>
    <ul>
      <li><a href="/danger-report?instructor=Bianca%20H.">Bianca H.</a></li>
      <li><a href="/danger-report?instructor=Felipe%20G.">Felipe G.</a></li>
    </ul>
    """


if __name__ == '__main__':
    app.run(debug=True)   # debug=True only matters locally — Render ignores it