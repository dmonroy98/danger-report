<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Danger Report</title>

    <style>
        :root {
            --bg: #f5f5f7;
            --card: white;
            --text: #1d1d1f;
            --border: #ddd;
            --hover: #f0f0f3;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #1c1c1e;
                --card: #2c2c2e;
                --text: #f5f5f7;
                --border: #3a3a3c;
                --hover: #3a3a3c;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--text);
        }

        .container {
            max-width: 1100px;
            margin: 40px auto;
            background: var(--card);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            opacity: 0;
            animation: fadeIn 0.4s ease forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .back-btn {
            background: var(--hover);
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text);
        }

        .back-btn:hover {
            opacity: 0.8;
        }

        select {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
        }

        /* Spotlight search */
        .search-box {
            width: 100%;
            padding: 12px 16px;
            margin-top: 10px;
            border-radius: 12px;
            border: 1px solid var(--border);
            font-size: 16px;
            background: var(--card);
            color: var(--text);
            box-shadow: 0 4px 14px rgba(0,0,0,0.08);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            font-size: 14px;
        }

        th {
            background: var(--hover);
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid var(--border);
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: var(--hover);
        }

        /* Day color classes */
        .day-m { background: #e8f4ff; }
        .day-tu { background: #e8fff3; }
        .day-w { background: #fff8e8; }
        .day-th { background: #f3e8ff; }
        .day-f { background: #ffe8e8; }
        .day-sa { background: #e8fffe; }
        .day-su { background: #f9e8ff; }

        @media (prefers-color-scheme: dark) {
            .day-m, .day-tu, .day-w, .day-th, .day-f, .day-sa, .day-su {
                filter: brightness(0.7);
            }
        }

        .export-btn {
            margin-top: 20px;
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            background: #007aff;
            color: white;
            cursor: pointer;
        }

        .export-btn:hover {
            opacity: 0.85;
        }
    </style>
</head>

<body>

<div class="container">

    <div class="top-bar">
        <button class="back-btn" onclick="window.location.href='/'">← Back</button>

        <form id="instructorForm" method="POST">
            <select name="instructor" onchange="document.getElementById('instructorForm').submit()">
                {% for name in instructors %}
                    <option value="{{ name }}" {% if name == current %}selected{% endif %}>
                        {{ name }}
                    </option>
                {% endfor %}
            </select>
        </form>
    </div>

    <h1>Danger Report – {{ current }}</h1>

    <!-- Spotlight Search -->
    <input type="text" id="searchBox" class="search-box" placeholder="Search…">

    <div id="tableContainer">
        {{ table|safe }}
    </div>

    <button class="export-btn" onclick="exportPNG()">Export as PNG</button>

</div>

<script>
/* ------------------------------
   Spotlight-style search
--------------------------------*/
document.getElementById("searchBox").addEventListener("input", function () {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll("table tbody tr");

    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(filter) ? "" : "none";
    });
});

/* ------------------------------
   Column sorting
--------------------------------*/
document.querySelectorAll("th").forEach((header, index) => {
    header.addEventListener("click", () => {
        const table = header.closest("table");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));
        const asc = header.classList.toggle("asc");

        rows.sort((a, b) => {
            const A = a.children[index].innerText.trim();
            const B = b.children[index].innerText.trim();
            return asc ? A.localeCompare(B) : B.localeCompare(A);
        });

        rows.forEach(r => tbody.appendChild(r));
    });
});

/* ------------------------------
   Export table to PNG with timestamp + logo
--------------------------------*/
function exportPNG() {
    html2canvas(document.querySelector("#tableContainer")).then(canvas => {
        const ctx = canvas.getContext("2d");

        // Timestamp
        const timestamp = new Date().toLocaleString();

        // Logo (replace with your real logo URL)
        const logo = new Image();
        logo.src = "https://upload.wikimedia.org/wikipedia/commons/3/3a/Logo_placeholder.png";

        logo.onload = () => {
            const logoSize = 24;
            const padding = 20;

            // Draw logo bottom-right
            ctx.drawImage(
                logo,
                canvas.width - logoSize - padding,
                canvas.height - logoSize - padding,
                logoSize,
                logoSize
            );

            // Draw timestamp to the left of logo
            ctx.font = "16px -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial";
            ctx.fillStyle = "rgba(0,0,0,0.65)";
            ctx.textAlign = "right";

            ctx.fillText(
                timestamp,
                canvas.width - logoSize - padding - 10,
                canvas.height - padding
            );

            // Download
            const link = document.createElement("a");
            link.download = "danger-report.png";
            link.href = canvas.toDataURL();
            link.click();
        };
    });
}

/* Load html2canvas dynamically */
(function loadCanvasLib() {
    const script = document.createElement("script");
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
    document.body.appendChild(script);
})();
</script>

</body>
</html>