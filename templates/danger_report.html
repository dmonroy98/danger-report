<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Danger Report – {{ instructor }}</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 1400px;
        }

        h1 {
            margin-bottom: 0.5rem;
        }

        .updated {
            color: #6c757d;
            margin-bottom: 1.5rem;
        }

        .search-box {
            max-width: 450px;
            margin-bottom: 1.5rem;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table {
            margin-bottom: 0;
        }

        .table th {
            background-color: #f1f3f5;
            font-weight: 600;
        }

        /* Hover effect — works very nicely with the background colors */
        .table tbody tr:hover {
            filter: brightness(92%);
            transition: filter 0.2s;
        }

        .btn-export {
            min-width: 140px;
        }
    </style>
</head>
<body>

<div class="container">

    <!-- Header + buttons -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Danger Report – {{ instructor }}</h1>

        <div>
            <a href="/" class="btn btn-outline-secondary me-2">
                ← Back / Reset
            </a>

            <button id="exportBtn" class="btn btn-primary btn-export">
                Export as PNG
            </button>
        </div>
    </div>

    <!-- Updated time -->
    <p class="updated">Updated: {{ updated_at }}</p>

    <!-- Instructor selector -->
    <form method="GET" class="mb-4">
        <div class="input-group" style="max-width: 420px;">
            <span class="input-group-text">Instructor</span>
            <select name="instructor" class="form-select" onchange="this.form.submit()">
                {% for inst in instructors %}
                    <option value="{{ inst }}" {% if inst == instructor %}selected{% endif %}>
                        {{ inst }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>

    <!-- Search box -->
    <div class="search-box">
        <input type="text" id="searchInput" class="form-control" placeholder="Search anything in the table...">
    </div>

    <!-- The table -->
    <div class="table-container">
        {{ table_html | safe }}
    </div>

    <!-- Small message if something went wrong -->
    {% if 'Error' in table_html or not table_html %}
    <div class="alert alert-warning">
        No data loaded or error occurred.<br>
        Please check server logs.
    </div>
    {% endif %}

</div>


<!-- ─── JavaScript ────────────────────────────────────────────────────────────── -->
<script>
    // Quick real-time search
    document.getElementById('searchInput').addEventListener('keyup', function() {
        let filter = this.value.toLowerCase();
        let rows = document.querySelectorAll('.table tbody tr');

        rows.forEach(row => {
            let text = row.textContent.toLowerCase();
            row.style.display = text.includes(filter) ? '' : 'none';
        });
    });


    // Export table area as PNG
    document.getElementById('exportBtn').addEventListener('click', function () {
        const container = document.querySelector('.table-container');

        if (!container) {
            alert("No table found to export");
            return;
        }

        html2canvas(container, {
            scale: 2,
            useCORS: true,
            backgroundColor: '#ffffff'
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Danger-Report - ${'{{ instructor }}'.replace(/ /g, '-')}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(err => {
            console.error(err);
            alert("Could not create image.\nTry again or check console.");
        });
    });
</script>

<!-- html2canvas library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Bootstrap JS (optional but nice) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>