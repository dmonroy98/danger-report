<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danger Report – {{ instructor }}</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        body {
            background-color: #f8f9fa;
            color: #212529;
            padding: 2rem 1rem;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
        }
        .container {
            max-width: 1400px;
        }
        .header-row {
            margin-bottom: 1.75rem;
        }
        h1 {
            margin: 0;
            font-weight: 600;
        }
        .updated {
            color: #6c757d;
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
        }
        .search-box {
            max-width: 420px;
            margin-bottom: 1.5rem;
        }
        .table-container {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.07);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .table {
            margin-bottom: 0;
            font-size: 0.95rem;
        }
        .table th {
            background-color: #f1f3f5;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        .table td, .table th {
            vertical-align: middle;
            padding: 0.75rem 1rem;
        }
        /* Hover effect works well with the inline background colors */
        .table tbody tr:hover {
            filter: brightness(92%);
            transition: filter 0.2s ease;
        }
        .alert-no-data {
            margin-top: 1.5rem;
        }
        .btn-export {
            min-width: 140px;
        }
    </style>
</head>
<body>

<div class="container">

    <!-- Header + actions -->
    <div class="d-flex justify-content-between align-items-center header-row">
        <h1>Danger Report – {{ instructor }}</h1>
        <div>
            <a href="/" class="btn btn-outline-secondary me-2">
                ← Back / Reset
            </a>
            <button id="exportBtn" class="btn btn-primary btn-export">
                Export as PNG
            </button>
        </div>
    </div>

    <!-- Updated timestamp -->
    <p class="updated">Updated: {{ updated_at }}</p>

    <!-- Instructor dropdown -->
    <form method="GET" class="mb-4">
        <div class="input-group" style="max-width: 420px;">
            <span class="input-group-text">Instructor</span>
            <select name="instructor" class="form-select" onchange="this.form.submit()">
                {% for inst in instructors %}
                    <option value="{{ inst }}" {% if inst == instructor %}selected{% endif %}>
                        {{ inst }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>

    <!-- Search -->
    <div class="search-box">
        <input type="text" id="searchInput" class="form-control" placeholder="Search table (class name, date, location, etc.)...">
    </div>

    <!-- Table area -->
    <div class="table-container">
        {{ table_html | safe }}
    </div>

    <!-- Fallback message if something failed -->
    {% if 'Error' in table_html or not table_html %}
    <div class="alert alert-warning alert-no-data">
        <strong>No data loaded</strong> or an error occurred while reading the sheet.
        <br>Please check the server logs or try another instructor.
    </div>
    {% endif %}

</div>

<!-- JavaScript -->
<script>
    // Real-time table search
    document.getElementById('searchInput').addEventListener('keyup', function() {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll('.table tbody tr');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(filter) ? '' : 'none';
        });
    });

    // Export visible table area as PNG
    document.getElementById('exportBtn').addEventListener('click', function() {
        const container = document.querySelector('.table-container');
        if (!container) {
            alert("No table found to export.");
            return;
        }

        html2canvas(container, {
            scale: 2,
            useCORS: true,
            backgroundColor: '#ffffff',
            logging: false
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Danger-Report_${'{{ instructor }}'.replace(/[^a-z0-9]/gi, '_')}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(err => {
            console.error("Export error:", err);
            alert("Failed to generate image.\nCheck console for details.");
        });
    });
</script>

<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-9KkIqdfH7y0eK3cOkzAUth9+3B3v4vA3zq2r2fQ6vW3rW9Z5Vv2bW0g2f2f2zZ9Z2oV3Q1f2Q6vW3rW9Z5Vv2bW0" crossorigin="anonymous"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>