<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Danger Report</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* Minimal page-specific tweaks; keep most styles in style.css */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 16px 0;
    }
    .btn {
      background: transparent;
      border: 1px solid rgba(0,0,0,0.08);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.12s ease;
    }
    .btn:hover { background: rgba(0,0,0,0.03); transform: translateY(-1px); }
    .instructor-select {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #fff;
      min-width: 220px;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }
    .loading-dot { display:inline-block; width:8px; height:8px; border-radius:50%; background:#666; margin-left:8px; opacity:0; animation: blink 1s infinite; }
    @keyframes blink { 0%,100% { opacity:0 } 50% { opacity:1 } }
  </style>
</head>
<body>
  <main class="container">
    <header class="hero">
      <img id="logo" src="{{ url_for('static', filename='logo.png') }}" alt="Danger Report logo" />
      <h1 class="hero-title">Danger Report</h1>
      <p class="hero-sub">Reports and instructor context</p>
    </header>

    <nav class="toolbar" role="navigation" aria-label="Report toolbar">
      <button id="backBtn" class="btn" type="button" aria-label="Go back">‚Üê Back</button>

      <div>
        <label for="instructorSelect" class="sr-only">Change instructor</label>
        <select id="instructorSelect" class="instructor-select" aria-label="Change instructor">
          {% for inst in instructors %}
            <option value="{{ inst.id }}" {% if inst.id == current %}selected{% endif %}>{{ inst.name }}</option>
          {% endfor %}
        </select>
        <span id="instructorLoading" class="loading-dot" aria-hidden="true"></span>
      </div>

      <div style="margin-left:auto; display:flex; align-items:center; gap:12px;">
        <div id="instructorInfo" aria-live="polite">
          <strong id="instructorName">{{ instructors | selectattr('id','equalto', current) | map(attribute='name') | list | first }}</strong>
        </div>
      </div>
    </nav>

    <section id="reportContent" class="report-content" aria-label="Danger reports">
      <!-- Server should render initial report list/details here for the current instructor -->
      {% include 'partials/report_list.html' %}
    </section>
  </main>

  <script>
    // Back button: prefer history.back, fallback to reports list
    document.getElementById('backBtn').addEventListener('click', function() {
      if (document.referrer && document.referrer !== window.location.href) {
        window.history.back();
      } else {
        window.location.href = '/reports';
      }
    });

    // Instructor dropdown behavior
    const select = document.getElementById('instructorSelect');
    const loadingDot = document.getElementById('instructorLoading');
    select.addEventListener('change', async function() {
      const instructorId = this.value;
      // show loading indicator
      loadingDot.style.opacity = '1';

      try {
        // Preferred: fetch minimal instructor data and updated report HTML fragment
        const res = await fetch('/api/change-instructor', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ instructor_id: instructorId })
        });

        if (!res.ok) throw new Error('Network error');

        const data = await res.json();

        // Update instructor name
        const nameEl = document.getElementById('instructorName');
        if (nameEl && data.name) nameEl.textContent = data.name;

        // If server returns an HTML fragment for reports, replace content
        if (data.reports_html) {
          document.getElementById('reportContent').innerHTML = data.reports_html;
          // update URL so selection persists on reload
          const url = new URL(window.location);
          url.searchParams.set('instructor', instructorId);
          window.history.replaceState({}, '', url);
        } else {
          // Fallback: redirect to server-rendered page for the instructor
          window.location.href = `/danger-report?instructor=${encodeURIComponent(instructorId)}`;
        }
      } catch (err) {
        console.error(err);
        // On error, fallback to redirect
        window.location.href = `/danger-report?instructor=${encodeURIComponent(instructorId)}`;
      } finally {
        loadingDot.style.opacity = '0';
      }
    });

    // Optional helper for progressive enhancement: applyInstructorData can be called by other scripts
    function applyInstructorData(data) {
      if (!data) return;
      const nameEl = document.getElementById('instructorName');
      if (nameEl && data.name) nameEl.textContent = data.name;
      if (data.reports_html) {
        document.getElementById('reportContent').innerHTML = data.reports_html;
      }
    }
  </script>
</body>
</html>